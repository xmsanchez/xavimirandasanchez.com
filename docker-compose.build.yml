services:
  hugo-build:
    # Use pre-built image if available, otherwise build
    image: xavi-portfolio-hugo:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: xavi-portfolio-build
    entrypoint: ["/bin/sh", "-c"]
    volumes:
      - .:/src
      - node_modules:/src/node_modules
      - npm_cache:/root/.npm
    working_dir: /src
    command: >
      "
        set -e &&
        if [ ! -d node_modules ] || [ ! -f node_modules/.package-lock.json ] || [ package.json -nt node_modules/.package-lock.json ]; then
          echo 'Installing npm dependencies...' &&
          npm install --prefer-offline --no-audit --progress=false
        fi &&
        echo 'Building CSS with Tailwind...' &&
        mkdir -p static/css &&
        npx tailwindcss -i ./assets/css/main.css -o ./static/css/main.css --minify &&
        echo 'Building site...' &&
        hugo --minify
      "
    environment:
      - HUGO_CACHEDIR=/tmp/hugo_cache

volumes:
  node_modules:
  npm_cache:

